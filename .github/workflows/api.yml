# API testing workflow config for CI/CD on Github

name: API continuous integration

# Controls when the action will run.
on:
  # Triggers the workflow on any git push
  push:
  # Triggers workflow for any branch on pull requests
  pull_request:
    branches:
      - '**'
  # Allows running this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow is defined of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "api_test"
  api_test:
    strategy:
      # don't cancel other jobs if one fails
      fail-fast: false
      # tests must be run on both Ubuntu & macOS
      matrix:
        os: [ubuntu, macos]

    runs-on: ${{ matrix.os }}-latest

    # Environment variables available to every step
    env:
      # Skip installing production gems (e.g., pg)
      BUNDLE_WITHOUT: production

      # Run app in test environment
      RACK_ENV: test

      # SQLite database file for tests
      DB_FILENAME: ${{ secrets.DB_FILENAME }}
      DATABASE_URL: sqlite://${{ github.workspace }}/${{ secrets.DB_FILENAME }}

      # AWS & SQS configuration for Shoryuken background worker
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      SQS_QUEUE_URL: ${{ secrets.SQS_QUEUE_URL }}
      SQS_QUEUE_NAME: ${{ secrets.SQS_QUEUE_NAME }}

      # Session secret for Rack
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v4
    
      # Sets up Ruby with Bundler caching
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      # Debug: Verify important variables exist
      - name: Debug Environment Variables
        run: |
          echo "Workspace: ${{ github.workspace }}"
          echo "DB Filename: $DB_FILENAME"
          echo "DATABASE_URL: $DATABASE_URL"
          echo "AWS Region: $AWS_REGION"
          echo "Queue Name: $SQS_QUEUE_NAME"

      # Ensure database directory exists (SQLite needs it)
      - name: Ensure database directory exists
        run: mkdir -p $(dirname "${{ secrets.DB_FILENAME }}")

      # Debug secret length
      - name: Verify Secret Length
        run: echo "The session secret length is ${{ secrets.SESSION_SECRET.length }}"

      # Run database migrations for testing
      - name: Setup test database
        run: bundle exec rake db:migrate

      # Shoryuken worker in background for parallel job processing
      # Worker must be running so specs can publish messages to SQS
      - name: Start test worker
        run: |
          echo "Starting Shoryuken worker in background..."
          rake worker:run:test &
          # Wait a moment to ensure worker boots before running tests
          sleep 3

      - name: Run all specs
        run: bundle exec rake spec
      

      